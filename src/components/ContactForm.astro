<div class="form-div-wrapper contact-container">
  <form class="contact-form" method="post" action="#">
    <div class="form-group">
      <label for="firstName" data-i18n="contact.firstName">First Name *</label>
      <input type="text" id="firstName" name="firstName" required />
    </div>

    <div class="form-group">
      <label for="lastName" data-i18n="contact.lastName">Last Name *</label>
      <input type="text" id="lastName" name="lastName" required />
    </div>

    <div class="form-group full-width">
      <label for="email" data-i18n="contact.email">Email *</label>
      <input type="email" id="email" name="email" required />
    </div>

    <div class="form-group full-width">
      <label for="message" data-i18n="contact.message">Message</label>
      <textarea id="message" name="message" rows="4"></textarea>
    </div>

    <div class="form-group full-width">
      <div class="cf-turnstile" data-sitekey="0x4AAAAAABnGYh55M5coCtFR"></div>
    </div>

    <div class="form-group full-width">
      <button class="contact-submit" type="submit" data-i18n="contact.submit">Submit</button>
    </div>
  </form>
</div>

<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer
></script>

<script>
  function initializeContactForm() {
    const contactForm = document.querySelector('.contact-form');

    if (!contactForm) {
      return;
    }

    contactForm.removeEventListener('submit', handleFormSubmit);

    contactForm.addEventListener('submit', handleFormSubmit);
  }

  async function handleFormSubmit(e) {
    e.preventDefault();
    e.stopPropagation();

    const submitButton = this.querySelector('.contact-submit');
    const originalText = submitButton.textContent;

    const t = (key) => window.__i18n ? window.__i18n.getTranslation(window.__i18n.getSavedLang(), key) : null;

    submitButton.textContent = t('contact.sending') || 'SENDING...';
    submitButton.disabled = true;
    submitButton.style.opacity = '0.7';

    const formData = new FormData(this);

    const turnstileResponse = document.querySelector(
      '[name="cf-turnstile-response"]'
    )?.value;

    if (!turnstileResponse) {
      alert(t('contact.securityCheck') || 'Please complete the security verification.');
      submitButton.textContent = originalText;
      submitButton.disabled = false;
      submitButton.style.opacity = '1';
      return;
    }

    const data = {
      form_type: 'contact',
      firstName: formData.get('firstName'),
      lastName: formData.get('lastName'),
      email: formData.get('email'),
      message: formData.get('message') || '',
      'cf-turnstile-response': turnstileResponse,
    };

    try {
      const response = await fetch('/form-handler.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const contentType = response.headers.get('content-type');
      if (!contentType || !contentType.includes('application/json')) {
        const textResponse = await response.text();
        console.error('Non-JSON response:', textResponse);
        throw new Error(
          'Server returned non-JSON response: ' + textResponse.substring(0, 100)
        );
      }

      const result = await response.json();

      if (response.ok && result.success) {
        const container = document.querySelector('.contact-container');
        const successTitle = t('contact.successTitle') || 'Message Sent Successfully!';
        container.innerHTML = `
          <div class="success-message" style="text-align: center;">
            <h3>${successTitle}</h3>
            <p>${result.message}</p>
          </div>
        `;
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: 'form_submit',
          form_type: 'contact',
        });
      } else {
        const errorMessage = result.error || 'Unknown error occurred';
        alert('Error: ' + errorMessage);

        submitButton.textContent = originalText;
        submitButton.disabled = false;
        submitButton.style.opacity = '1';
      }
    } catch (error) {
      let errorMessage = t('contact.errorSending') || 'There was an error sending your message. ';

      if (error.name === 'TypeError' && error.message.includes('fetch')) {
        errorMessage += t('contact.errorInternet') || 'Please check your internet connection.';
      } else if (error.message.includes('JSON')) {
        errorMessage += t('contact.errorFormat') || 'Server response format error.';
      } else if (error.message.includes('non-JSON')) {
        errorMessage += t('contact.errorConfig') || 'Server configuration issue.';
      } else {
        errorMessage += t('contact.errorRetry') || 'Please try again later.';
      }

      alert(errorMessage);

      submitButton.textContent = originalText;
      submitButton.disabled = false;
      submitButton.style.opacity = '1';
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeContactForm);
  } else {
    initializeContactForm();
  }

  document.addEventListener('astro:after-swap', () => {
    setTimeout(initializeContactForm, 50);
  });

  window.addEventListener('load', initializeContactForm);
</script>

<style>
  .error-message {
    color: #ef4444;
    font-size: 14px;
    margin-top: 5px;
    margin-bottom: 0;
  }

  .success-message {
    background-color: #dcfce7;
    border: 1px solid #bbf7d0;
    color: #166534;
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
    text-align: center;
  }

  .success-message h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
  }

  .success-message p {
    margin: 0;
    font-weight: 600;
  }

  .contact-container:has(.success-message) .contact-form {
    display: none !important;
  }
</style>
